---
title: "Summary Statistics"
site: workflowr::wflow_site
output:
  workflowr::wflow_html:
    toc: true
editor_options:
  chunk_output_type: console
---
<!-- author: "Julian McClellan" -->
<!-- date: "2/something/2020" -->
<!-- output:  -->
<!-- html_document: -->
<!-- toc: true -->

```{r setup, include=FALSE}
source("R/functions.R")
source("R/packages.R")
knitr::opts_chunk$set(echo = F, message = F, warning=F)
options(scipen=999) # No scientific notation

dataPBRaw <- fread("data/pricebeliefs.csv")
dataCSRaw <- fread("data/cleansample.csv") 
dataCS  <- getDataCS()
dataPB  <- getDataPB()
dataJoinedLoose  <- getDataJoined(join = "loose")
dataJoinedLooser  <- getDataJoined(join = "looser")
```

# Data Cleaning procedures

## Clean Sample 

* Initial Size: `r nrow(dataCSRaw)`
* Remove blank email addresses (`r nrow(dataCSRaw[email == ""])` in raw data).
* `period` column created with values `fall12` and `spring13` corresponding to
  `TRUE` values of `fall12dum` and `spring13dum` respectively.
* Removed responses from those with more than 10 semesters of college. (`r nrow(dataCSRaw[semesters > 10])` in raw data)
  * Note that the clean sample data and price beliefs data appear to have
    different values of `semester` and `freshdum` for the same instances of
    `email` and `period` (loose join conditions). No explanation as of yet.
* Final size: `r nrow(dataCS)`

## Price Beliefs

* Initial Size: `r nrow(dataPBRaw)`
* __Did not__ remove unfinished(?) (`finished == 0`) surveys (`r nrow(dataPBRaw[finished == 0])` did not finish?)
* `period` column created with values `fall12` and `spring13`.
  - `startyear` and `startmonth` created from original column `startdate`
  - `period=fall12` set if `startyear == 2012` and (`startmonth == 11` or `startmonth == 12`)
  - `period=spring13` set if `startyear == 2013` and `startmonth == 4`
* Removed responses from those with more than 10 semesters of college (`r nrow(dataPBRaw[semesters > 10])` in raw data.)
  * Note that the clean sample data and price beliefs data appear to have
    different values of `semester` and `freshdum` for the same instances of
    `email` and `period` (loose join conditions). No explanation as of yet.
* Removed expectations of online new price that are < 10% or > 150% of the
  new bookstore price (`r nrow(dataPBRaw[newexpratio < .1 | newexpratio > 1.5])` in raw data.)
* Final size: `r nrow(dataPB)`

### Ongoing Price Belief Work


#### Non-sensical expectation filtering

In [this paper](https://www.sciencedirect.com/science/article/pii/S016726811630021X?via%3Dihub#fn0060)
they drop nonsensical answers; expectations less than 10% or greater than 150%
of the bookstore price. However, the price beliefs data has expectation ratio
columns for new, used, and rent prices. I'm assuming they only use the new expectation ratios?

```{r pbexpratioclean, echo=T}
(
 pbRatios <- names(dataJoinedLoose)[grepl("ratio", names(dataJoinedLoose))]
)
```

#### Price-belief with no treatment/control information (can't join to Clean Sample data)

```{r pbonly}
createPBOnlyBreakdownPlot()
```

# Plots for Clean Sample Data 

## Treatment Breakdown: Obs Level
```{r cs_gtreat, include=TRUE}
createTreatmentPlot("cs", dataCS)
```

### Freshman Status
```{r, include=TRUE}
createTreatmentPlotFreshman("cs", dataCS)
```

### Class in Student Major?
```{r, include=TRUE}
createTreatmentPlotMajorClass("cs", dataCS)
```

## Treatment Breakdown: Classes Level
```{r cs_gtreatclass, include=TRUE}
createTreatmentPlotClasses("cs", dataCS)
```

### Classes: Book Price Comparison
```{r cs_gtreatbprice, include=TRUE}
createTreatmentPlotClassesPriceDiff("cs", dataCS)
```



# Plots for Loose Joined Data

## Overview of Join

The "loose" joined data joins the clean sample and price beliefs tables on
`email` and `period`. Period joins are allowed only if the `period` of the
clean sample is the same as the price beliefs `period`.

## Treatment Breakdown: Obs Level
```{r, include=TRUE}
createTreatmentPlot("loose", dataJoinedLoose)
```

### Freshman Status
```{r, include=TRUE}
createTreatmentPlotFreshman("loose", dataJoinedLoose)
```

### Class in Student Major?
```{r, include=TRUE}
createTreatmentPlotMajorClass("loose", dataJoinedLoose)
```

## Treatment Breakdown: Classes Level
```{r, include=TRUE}
createTreatmentPlotClasses("loose", dataJoinedLoose)
```

### Classes: Book Price Comparison
```{r, include=TRUE}
createTreatmentPlotClassesPriceDiff("loose", dataJoinedLoose)
```

# Plots for Looser Joined Data

## Overview of Join

The "looser" joined data joins the clean sample and price beliefs tables on
`email` and `period`. Period joins are allowed as long as the `period` of the
clean sample occurs during the same `period` or earlier than the price beliefs.
`period.cs <= period.pb`

## Treatment Breakdown: Obs Level
```{r, include=TRUE}
createTreatmentPlot("looser", dataJoinedLooser)
```

### Freshman Status
```{r, include=TRUE}
createTreatmentPlotFreshman("looser", dataJoinedLooser)
```

### Class in Student Major?
```{r, include=TRUE}
createTreatmentPlotMajorClass("looser", dataJoinedLooser)
```

## Treatment Breakdown: Classes Level
```{r, include=TRUE}
createTreatmentPlotClasses("looser", dataJoinedLooser)
```

### Classes: Book Price Comparison
```{r, include=TRUE}
createTreatmentPlotClassesPriceDiff("looser", dataJoinedLooser)
```
